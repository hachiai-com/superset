name: Build and Push Superset

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to build for'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
  push:
    branches:
      - master
      - main
    paths:
      - 'Dockerfile'
      - 'docker/**'
      - 'superset/**'
      - 'requirements/**'
      - '.github/workflows/build-and-push-superset.yml'

env:
  # Build configuration
  BUILD_PROJECT_ID: v2-prod-project
  IMAGE_NAME: superset

jobs:
  validate-inputs:
    name: Validate Inputs
    runs-on: 
      - self-hosted
      - Linux
      - X64
    if: github.event_name == 'workflow_dispatch'
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      build_project_id: ${{ steps.validate.outputs.build_project_id }}
    steps:
      - name: Validate and Set Environment Variables
        id: validate
        run: |
          # Set environment variables based on input
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          BUILD_PROJECT_ID="v2-prod-project"
          
          # Output variables
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "build_project_id=$BUILD_PROJECT_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Environment: $ENVIRONMENT"
          echo "‚úÖ Build Project: $BUILD_PROJECT_ID"
          echo "‚úÖ Image Tag: ${{ github.sha }}"

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
      - name: Set Build Project ID
        id: set-project
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD_PROJECT_ID="${{ needs.validate-inputs.outputs.build_project_id }}"
          else
            BUILD_PROJECT_ID="v2-prod-project"
          fi
          echo "build_project_id=$BUILD_PROJECT_ID" >> $GITHUB_ENV
          echo "‚úÖ Build Project: $BUILD_PROJECT_ID"
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CREDENTIALS_PROD }}
      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.BUILD_PROJECT_ID }}
      - name: Configure Docker
        run: |
          gcloud --quiet auth configure-docker northamerica-northeast2-docker.pkg.dev
      - name: Verify Docker Authentication
        run: |
          echo "Testing Docker authentication..."
          docker pull hello-world
          echo "‚úÖ Docker authentication verified"
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            northamerica-northeast2-docker.pkg.dev/${{ env.BUILD_PROJECT_ID }}/llm-artifactory/${{ env.IMAGE_NAME }}:${{ github.sha }}
            northamerica-northeast2-docker.pkg.dev/${{ env.BUILD_PROJECT_ID }}/llm-artifactory/${{ env.IMAGE_NAME }}:latest
            northamerica-northeast2-docker.pkg.dev/${{ env.BUILD_PROJECT_ID }}/llm-artifactory/${{ env.IMAGE_NAME }}:prod-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Output Image URI
        run: |
          IMAGE_URI="northamerica-northeast2-docker.pkg.dev/${{ env.BUILD_PROJECT_ID }}/llm-artifactory/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "‚úÖ Built and pushed image: $IMAGE_URI"
          echo "üì¶ Image tags:"
          echo "  - $IMAGE_URI"
          echo "  - northamerica-northeast2-docker.pkg.dev/${{ env.BUILD_PROJECT_ID }}/llm-artifactory/${{ env.IMAGE_NAME }}:latest"
          echo "  - northamerica-northeast2-docker.pkg.dev/${{ env.BUILD_PROJECT_ID }}/llm-artifactory/${{ env.IMAGE_NAME }}:prod-latest"

  notify:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    steps:
    - name: Build Summary
      run: |
        if [ "${{ needs.build-and-push.result }}" == "success" ]; then
          echo "üéâ Build and push successful!"
          echo "Image: northamerica-northeast2-docker.pkg.dev/v2-prod-project/llm-artifactory/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
        else
          echo "‚ùå Build and push failed!"
          echo "Check the logs above for more details."
          exit 1
        fi

